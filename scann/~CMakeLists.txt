cmake_minimum_required(VERSION 3.10)
project(ProjectName)

set(CMAKE_POSITION_INDEPENDENT_CODE ON)
set(CMAKE_CXX_STANDARD 17)

add_compile_options(-mssse3 -msse4)

# list(APPEND CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/modules")

# abslei 
# taken from contrib

# gtest 
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/609281088cfefc76f9d0ce82e1ff6c30cc3591e5.zip
)
FetchContent_MakeAvailable(googletest)
include(GoogleTest)

# protobuf
# taken from contrib

set(Protobuf_INCLUDE_DIRS ${CMAKE_SOURCE_DIR}/contrib/protobuf/src)
set(Protobuf_IMPORT_DIRS 
${CMAKE_SOURCE_DIR}/contrib/protobuf/src
${CMAKE_CURRENT_SOURCE_DIR}
)

# eigen3
set(Eigen3_DIR eigen-3.4.0/cmake)
find_package(Eigen3 REQUIRED)

# TensorFlow
# search in root (/usr/local) 
# find_package(TensorFlow REQUIRED)
# message("${TensorFlow_INCLUDE_DIRS}")
# message("${TensorFlow_LIBRARIES}")
set(TensorFlow_INCLUDE_DIRS ${CMAKE_CURRENT_SOURCE_DIR}/tensorflow/tensorflow)
# #message("${TensorFlow_INCLUDE_DIRS}")
set(TensorFlow_LIBRARIES 
${CMAKE_CURRENT_SOURCE_DIR}/tensorflow/libtensorflow_cc.so
# ${CMAKE_CURRENT_SOURCE_DIR}/tensorflow/libtensorflow_framework.so
)

add_library(tensorflow SHARED IMPORTED)

set_target_properties(tensorflow PROPERTIES 
IMPORTED_LOCATION 
${CMAKE_CURRENT_SOURCE_DIR}/tensorflow/libtensorflow_cc.so)

# add_library(tensorflow_framework STATIC IMPORTED)

# set_target_properties(tensorflow_framework PROPERTIES 
# IMPORTED_LOCATION 
# ${CMAKE_CURRENT_SOURCE_DIR}/tensorflow/libtensorflow_framework.so
# )

set(SCANN_INCLUDE_DIRS ${CMAKE_CURRENT_SOURCE_DIR}/scann_api CACHE PATH "")

set(INCLUDE_DIRS 
${CMAKE_CURRENT_SOURCE_DIR}
${CMAKE_CURRENT_BINARY_DIR}
${Protobuf_INCLUDE_DIRS}
${gtest_SOURCE_DIR}/include
${gtest_SOURCE_DIR}

${TensorFlow_INCLUDE_DIRS} 
${EIGEN3_INCLUDE_DIR} 
${Protobuf_INCLUDE_DIRS}
)

include_directories(${INCLUDE_DIRS})


set(PROTO_SOURCES
scann/data_format/features.proto
scann/partitioning/linear_projection_tree.proto
scann/partitioning/partitioner.proto
scann/partitioning/kmeans_tree_partitioner.proto

scann/proto/scann.proto
scann/proto/exact_reordering.proto
scann/proto/brute_force.proto
scann/proto/disjoint_restrict_token.proto
scann/proto/results.proto
scann/proto/crowding.proto
scann/proto/distance_measure.proto
scann/proto/projection.proto
scann/proto/metadata.proto
scann/proto/hash.proto
scann/proto/input_output.proto
scann/proto/restricts.proto
scann/proto/incremental_updates.proto
scann/proto/hashed.proto
scann/proto/partitioning.proto
scann/proto/centers.proto

scann/coscann/v2_restricts.proto
scann/trees/kmeans_tree/kmeans_tree.proto
)

protobuf_generate_cpp(PROTO_SRCS PROTO_HDRS ${PROTO_SOURCES})

add_library(cc_proto ${PROTO_SRCS} ${PROTO_HDRS})
target_include_directories(cc_proto PUBLIC
${CMAKE_CURRENT_BINARY_DIR}
${CMAKE_CURRENT_BINARY_DIR}/scann/proto
${CMAKE_CURRENT_BINARY_DIR}/scann/coscann
${CMAKE_CURRENT_BINARY_DIR}/scann/trees/kmeans_tree
${CMAKE_CURRENT_BINARY_DIR}/scann/partitioning
${CMAKE_CURRENT_BINARY_DIR}/scann/data_format
${Protobuf_INCLUDE_DIRS}
)

add_library(all_source STATIC
${CMAKE_CURRENT_SOURCE_DIR}/scann/data_format/dataset.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/data_format/gfv_properties.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/data_format/datapoint.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/data_format/docid_collection.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/metadata/metadata_getter.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/brute_force/brute_force.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/brute_force/scalar_quantized_brute_force.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/partitioning/partitioner_factory.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/partitioning/partitioner_factory_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/partitioning/partitioner_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/partitioning/kmeans_tree_partitioner_helper.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/partitioning/kmeans_tree_partitioner.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/partitioning/projecting_decorator.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/tree_x_hybrid/tree_x_hybrid_smmd.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/tree_x_hybrid/tree_x_params.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/tree_x_hybrid/tree_ah_hybrid_residual.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/trees/kmeans_tree/kmeans_tree.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/trees/kmeans_tree/training_options.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/trees/kmeans_tree/kmeans_tree_node.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/asymmetric_hashing2/querying.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/asymmetric_hashing2/searcher.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/asymmetric_hashing2/indexing.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/asymmetric_hashing2/training_options_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/asymmetric_hashing2/training_options.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/asymmetric_hashing2/training_model.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/hashing_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/lut16_avx512_prefetch.tpl.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/lut16_avx512_noprefetch.tpl.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/write_distances_to_topn.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/lut16_avx512_swizzle.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/lut16_sse4.tpl.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/lut16_avx512_smart.tpl.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/stacked_quantizers.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/asymmetric_hashing_impl_omit_frame_pointer.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/lut16_avx2.tpl.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/asymmetric_hashing_impl.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/hashes/internal/lut16_interface.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/scann_config_utils.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/fast_top_neighbors.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/memory_logging.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/gmm_utils.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/threads.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/io_npy.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/hash_leaf_helpers.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/util_functions.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/io_oss_wrapper.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/scalar_quantization_helpers.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/alignment.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/intrinsics/flags.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/input_data_utils.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/types.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/factory_helpers.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/common.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/top_n_amortized_constant.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/utils/reordering_helper.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/scann_ops/cc/scann.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/base/search_parameters.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/base/single_machine_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/base/restrict_allowlist.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/base/single_machine_factory_options.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/base/reordering_helper_factory.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/base/single_machine_factory_scann.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/oss_wrappers/scann_bits.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/oss_wrappers/scann_status_builder.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/oss_wrappers/scann_serialize.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/oss_wrappers/scann_aligned_malloc.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/oss_wrappers/scann_status.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/many_to_many/many_to_many_flags.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/many_to_many/fp8_transposed.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/many_to_many/many_to_many_double_top1.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/many_to_many/many_to_many_float_top1.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/many_to_many/many_to_many_float_results.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/many_to_many/many_to_many_double_results.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/cosine_distance.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/dot_product_sse4.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/l1_distance_sse4.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/l2_distance.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/l2_distance_avx1.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/dot_product_avx2.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/limited_inner_product.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/binary_distance_measure_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/l2_distance_sse4.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/dot_product_avx1.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/nonzero_intersect_distance.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/jaccard_distance.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/l1_distance.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/hamming_distance.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_one/dot_product.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/distance_measure_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/distance_measure_factory.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/distance_measures/one_to_many/one_to_many.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/projection/projection_factory.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/projection/identity_projection.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/projection/chunking_projection.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/projection/projection_base.cc
${CMAKE_CURRENT_SOURCE_DIR}/scann/projection/random_orthogonal_projection.cc
)

target_link_libraries(all_source PUBLIC 
cc_proto 
${TensorFlow_LIBRARIES}
tensorflow
# tensorflow_framework

absl::core_headers
absl::flags
absl::base
absl::memory
# absl::string
absl::flat_hash_set
absl::flat_hash_map
absl::status
absl::time
absl::random_random
absl::random_distributions
)

add_library(scann_interface STATIC
${CMAKE_CURRENT_SOURCE_DIR}/scann_api/scann/scann_searcher.cpp
${CMAKE_CURRENT_SOURCE_DIR}/scann_api/scann/scann_builder.cpp
# ${CMAKE_CURRENT_SOURCE_DIR}/scann/scann_ops/cpp_interface/scann_builder.cpp
# ${CMAKE_CURRENT_SOURCE_DIR}/scann/scann_ops/cpp_interface/scann_ops_pybind.cpp
)

target_link_libraries(scann_interface PUBLIC
all_source 
tensorflow
# tensorflow_framework

cc_proto 
${TensorFlow_LIBRARIES}

absl::core_headers
absl::flags
absl::base
absl::memory
# absl::string
absl::flat_hash_set
absl::flat_hash_map
absl::status
absl::time
absl::random_random
absl::random_distributions
)


# add_subdirectory(scann_api/scann)
# add_subdirectory(scann)

